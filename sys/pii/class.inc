(include 'sys/class.inc)

(def-class 'sys_pii)
(dec-method 'exit 'sys/pii/exit 'static '(r0))
(dec-method 'mmap 'sys/pii/mmap 'static '(r0 r1 r2 r3 r4 r5) '(r0))
(dec-method 'munmap 'sys/pii/munmap 'static '(r0 r1) '(r0))
(dec-method 'mprotect 'sys/pii/mprotect 'static '(r0 r1 r2) '(r0))
(dec-method 'open 'sys/pii/open 'static '(r0 r1 r2) '(r0))
(dec-method 'close 'sys/pii/close 'static '(r0) '(r0))
(dec-method 'ftruncate 'sys/pii/ftruncate 'static '(r0 r1) '(r0))
(dec-method 'unlink 'sys/pii/unlink 'static '(r0) '(r0))
(dec-method 'stat 'sys/pii/stat 'static '(r0 r1) '(r0))
(dec-method 'fcntl 'sys/pii/fcntl 'static '(r0 r1 r2) '(r0))
(dec-method 'write 'sys/pii/write 'static '(r0 r1 r2) '(r0))
(dec-method 'write_char 'sys/pii/write_char 'static '(r0 r1) '(r0))
(dec-method 'write_str 'sys/pii/write_str 'static '(r0 r1) '(r0))
(dec-method 'write_num 'sys/pii/write_num 'static '(r0 r1 r2))
(dec-method 'read 'sys/pii/read 'static '(r0 r1 r2) '(r0))
(dec-method 'read_char 'sys/pii/read_char 'static '(r0) '(r0))
(dec-method 'age 'sys/pii/age 'static '(r0) '(r0))
(dec-method 'time 'sys/pii/time 'static nil '(r0))

;debug helpers
(defcfun debug-num (s n)
	(when debug_mode
		(vp-push r0 r1)
		(fn-string (cat s ": ") r1)
		(call 'sys_pii 'write_str '(2 r1))
		(vp-pop r0 r1)
		(vp-push r0 r1 r2)
		(call 'sys_pii 'write_num (list 2 n 16))
		(call 'sys_pii 'write_char (list 2 10))
		(vp-pop r0 r1 r2)))

(defcfun debug-str (s)
	(when debug_mode
		(vp-push r0 r1)
		(if (reg s)
			(vp-cpy-rr s r1)
			(fn-string (cat s (char 10)) r1))
		(call 'sys_pii 'write_str '(2 r1))
		(vp-pop r0 r1)))

(defcfun debug-reg ()
	(when debug_mode
		(vp-push r14)
		(call 'sys_kernel 'debug_reg (list (cat *stream-name* ":" (str *stream-line*))))
		(vp-pop r14)))

(when (eql *os* 'Darwin)

;;;;;;;;;;;;;;;;;
; syscall for OSX
;;;;;;;;;;;;;;;;;

(defcvar 'sys_openat 0x1cf)
(defcvar 'sys_unlinkat 0x1d8)
(defcvar 'sys_fstatat 0x1d5)
(defcvar 'sys_exit 0x1)
(defcvar 'sys_read 0x3)
(defcvar 'sys_write 0x4)
(defcvar 'sys_close 0x6)
(defcvar 'sys_ftruncate 0xc9)
(defcvar 'sys_mmap 0xc5)
(defcvar 'sys_munmap 0x49)
(defcvar 'sys_mprotect 0x4a)
(defcvar 'sys_gettimeofday 0x74)
(defcvar 'sys_fcntl 0x5C)

(defcvar 'at_fdcwd 0xfffffffe)

(defcvar 'prot_none 0x0)
(defcvar 'prot_read 0x1)
(defcvar 'prot_write 0x2)
(defcvar 'prot_exec 0x4)

(defcvar 'map_shared 0x1)
(defcvar 'map_private 0x2)
(defcvar 'map_fixed 0x10)
(defcvar 'map_anon 0x1000)

(defcvar 'o_rdonly 0x0)
(defcvar 'o_wronly 0x1)
(defcvar 'o_rdwr 0x2)
(defcvar 'o_trunc 0x400)
(defcvar 'o_append 0x8)
(defcvar 'o_nonblock 0x4)
(defcvar 'o_creat 0x200)
(defcvar 'o_excl 0x800)
(defcvar 'o_nofollow 0x100)
(defcvar 'o_cloexec 0x1000000)

(defcvar 's_irwxu 0x1c0)
(defcvar 's_irusr 0x100)
(defcvar 's_iwusr 0x80)
(defcvar 's_ixusr 0x40)
(defcvar 's_irwxg 0x38)
(defcvar 's_irgrp 0x20)
(defcvar 's_iwgrp 0x10)
(defcvar 's_ixgrp 0x8)
(defcvar 's_irwxo 0x7)
(defcvar 's_iroth 0x4)
(defcvar 's_iwoth 0x2)
(defcvar 's_ixoth 0x1)
(defcvar 's_isuid 0x800)
(defcvar 's_isgid 0x400)
(defcvar 's_isvtx 0x200)

(defcvar 's_ifmt 0xf000)
(defcvar 's_ifdir 0x4000)
(defcvar 's_ifreg 0x8000)

(defcvar 'f_getfl 0x3)
(defcvar 'f_setfl 0x4)

(defcvar 'stat_mode 0x8)
(defcvar 'stat_fsize 0x48)
(defcvar 'stat_size 0x100)
(defcvar 'stat_mtime 0x38)

)
(when (and (eql *os* 'Linux) (eql *cpu* 'x86_64))

;;;;;;;;;;;;;;;;;;;;;;;
; syscall for Linux x64
;;;;;;;;;;;;;;;;;;;;;;;

(defcvar 'sys_openat 0x101)
(defcvar 'sys_unlinkat 0x107)
(defcvar 'sys_fstatat 0x106)
(defcvar 'sys_exit 0x3c)
(defcvar 'sys_read 0x0)
(defcvar 'sys_write 0x1)
(defcvar 'sys_open 0x2)
(defcvar 'sys_close 0x3)
(defcvar 'sys_unlink 0x57)
(defcvar 'sys_ftruncate 0x4d)
(defcvar 'sys_mmap 0x9)
(defcvar 'sys_munmap 0xb)
(defcvar 'sys_mprotect 0xa)
(defcvar 'sys_gettimeofday 0x60)
(defcvar 'sys_fcntl 0x48)

(defcvar 'at_fdcwd 0xffffff9c)

(defcvar 'prot_none 0x0)
(defcvar 'prot_read 0x1)
(defcvar 'prot_write 0x2)
(defcvar 'prot_exec 0x4)

(defcvar 'map_shared 0x1)
(defcvar 'map_private 0x2)
(defcvar 'map_fixed 0x10)
(defcvar 'map_anon 0x20)

(defcvar 'o_rdonly 0x0)
(defcvar 'o_wronly 0x1)
(defcvar 'o_rdwr 0x2)
(defcvar 'o_trunc 0x200)
(defcvar 'o_append 0x400)
(defcvar 'o_nonblock 0x800)
(defcvar 'o_creat 0x40)
(defcvar 'o_excl 0x80)
(defcvar 'o_nofollow 0x20000)
(defcvar 'o_cloexec 0x80000)

(defcvar 's_irwxu 0x1c0)
(defcvar 's_irusr 0x100)
(defcvar 's_iwusr 0x80)
(defcvar 's_ixusr 0x40)
(defcvar 's_irwxg 0x38)
(defcvar 's_irgrp 0x20)
(defcvar 's_iwgrp 0x10)
(defcvar 's_ixgrp 0x8)
(defcvar 's_irwxo 0x7)
(defcvar 's_iroth 0x4)
(defcvar 's_iwoth 0x2)
(defcvar 's_ixoth 0x1)
(defcvar 's_isuid 0x800)
(defcvar 's_isgid 0x400)
(defcvar 's_isvtx 0x200)

(defcvar 's_ifmt 0xf000)
(defcvar 's_ifdir 0x4000)
(defcvar 's_ifreg 0x8000)

(defcvar 'f_getfl 0x3)
(defcvar 'f_setfl 0x4)

(defcvar 'stat_mode 0x18)
(defcvar 'stat_fsize 0x30)
(defcvar 'stat_size 0x100)
(defcvar 'stat_mtime 0x58)

)
(when (and (eql *os* 'Linux) (eql *cpu* 'aarch64))

;;;;;;;;;;;;;;;;;;;;;;;;;;;
; syscall for Linux aarch64
;;;;;;;;;;;;;;;;;;;;;;;;;;

(defcvar 'sys_openat 0x38)
(defcvar 'sys_unlinkat 0x23)
(defcvar 'sys_fstatat 0x4F)
(defcvar 'sys_exit 0x5d)
(defcvar 'sys_read 0x3f)
(defcvar 'sys_write 0x40)
(defcvar 'sys_close 0x39)
(defcvar 'sys_ftruncate 0x2e)
(defcvar 'sys_mmap 0xde)
(defcvar 'sys_munmap 0xd7)
(defcvar 'sys_mprotect 0xe2)
(defcvar 'sys_gettimeofday 0xa9)
(defcvar 'sys_fcntl 0x19)

(defcvar 'at_fdcwd 0xffffff9c)

(defcvar 'prot_none 0x0)
(defcvar 'prot_read 0x1)
(defcvar 'prot_write 0x2)
(defcvar 'prot_exec 0x4)

(defcvar 'map_shared 0x1)
(defcvar 'map_private 0x2)
(defcvar 'map_fixed 0x10)
(defcvar 'map_anon 0x20)

(defcvar 'o_rdonly 0x0)
(defcvar 'o_wronly 0x1)
(defcvar 'o_rdwr 0x2)
(defcvar 'o_trunc 0x200)
(defcvar 'o_append 0x400)
(defcvar 'o_nonblock 0x800)
(defcvar 'o_creat 0x40)
(defcvar 'o_excl 0x80)
(defcvar 'o_nofollow 0x8000)
(defcvar 'o_cloexec 0x80000)

(defcvar 's_irwxu 0x1c0)
(defcvar 's_irusr 0x100)
(defcvar 's_iwusr 0x80)
(defcvar 's_ixusr 0x40)
(defcvar 's_irwxg 0x38)
(defcvar 's_irgrp 0x20)
(defcvar 's_iwgrp 0x10)
(defcvar 's_ixgrp 0x8)
(defcvar 's_irwxo 0x7)
(defcvar 's_iroth 0x4)
(defcvar 's_iwoth 0x2)
(defcvar 's_ixoth 0x1)
(defcvar 's_isuid 0x800)
(defcvar 's_isgid 0x400)
(defcvar 's_isvtx 0x200)

(defcvar 's_ifmt 0xf000)
(defcvar 's_ifdir 0x4000)
(defcvar 's_ifreg 0x8000)

(defcvar 'f_getfl 0x3)
(defcvar 'f_setfl 0x4)

(defcvar 'stat_dev 0x0)
(defcvar 'stat_mode 0x10)
(defcvar 'stat_nlink 0x14)
(defcvar 'stat_ino 0x8)
(defcvar 'stat_uid 0x18)
(defcvar 'stat_gid 0x1c)
(defcvar 'stat_rdev 0x20)
(defcvar 'stat_atime 0x48)
(defcvar 'stat_mtime 0x58)
(defcvar 'stat_ctime 0x68)
(defcvar 'stat_fsize 0x30)
(defcvar 'stat_blocks 0x40)
(defcvar 'stat_blksize 0x38)
(defcvar 'stat_size 0x80)

)
