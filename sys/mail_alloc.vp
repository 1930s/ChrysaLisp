(import 'inc/func.inc)
(import 'inc/mail.inc)

(def-func 'sys/mail_alloc)
	;outputs
	;r0 = mail message
	;trashes
	;r1-r3

	(f-bind 'sys_mail 'statics r0)
	(vp-add-cr ml_statics_heap r0)
	(f-call 'sys_heap 'alloc '(r0) '(r1))
	(vp-cpy-ri r0 r1 0)
	(vp-lea-i r1 ptr_size r0)
	(vp-cpy-cr msg_header_size r1)
	(vp-cpy-ri r1 r0 msg_length)
	(vp-xor-rr r1 r1)
	(vp-cpy-ri r1 r0 msg_parcel_size)
	(vp-ret)

(def-func-end)
