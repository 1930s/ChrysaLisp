(import 'inc/func.inc)
(import 'inc/task.inc)

(def-func 'sys/task_stop)
	;remove task control block
	(f-bind 'sys_task 'statics r0)
	(vp-cpy-ir r0 tk_statics_current_tcb r1)
	(vp-cpy-rr r1 r2)
	(ln-remove-node r2 r15)

	;decrement task count
	(vp-cpy-ir r0 tk_statics_task_count r2)
	(vp-dec r2)
	(vp-cpy-ri r2 r0 tk_statics_task_count)

	;free our task control block
	(vp-sub-cr ptr_size r1)
	(vp-cpy-ir r1 r0)
	(hp-freecell r0 r1 r2)
	(f-jmp 'sys_task 'restore)

(def-func-end)
