(import 'inc/func.inc)
(import 'inc/mail.inc)

(def-func 'sys/mail_alloc_parcel)
	;inputs
	;r0 = parcel size
	;outputs
	;r0 = mail message
	;trashes
	;r1-r3

	(vp-cpy-rr r0 r5)
	if r0, <=, msg_size
		f_call sys_mail, alloc, {}, {r0}
	else
		f_call sys_mem, alloc, {r0}, {r0, _}
		vp_cpy_cl 0, [r0 + msg_parcel_size]
	endif
	(vp-cpy-ri r5 r0 msg_length)
	(vp-ret)

(def-func-end)
