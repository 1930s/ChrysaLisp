;;;;;;;;;;;;;;;;;
; VP Instructions
;;;;;;;;;;;;;;;;;

(equate 'r0 'r0 'r1 'r1 'r2 'r2 'r3 'r3 'r4 'r4 'r5 'r5 'r6 'r6 'r7 'r7 'r8 'r8
	'r9 'r9 'r10 'r10 'r11 'r11 'r12 'r12 'r13 'r13 'r14 'r14 'r15 'r15)

(defcompilefun reg (r)
	(defq c 0 n nil l '(r0 r1 r2 r3 r4 r5 r6 r7 r8 r9 r10 r11 r12 r13 r14 r15))
	(while (and (not n) (lt c (length l)))
		(if (eql (elem c l) r) (setq n c) (setq c (inc c)))) n)

(defcompilefun vp-label (s) (emit `(emit-label ',s)) (equate s 0))
(defcompilefun vp-align (&rest b) (emit `(emit-align ~b)))
(defcompilefun vp-string (&rest b) (emit `(emit-string ~b)))
(defcompilefun vp-byte (&rest b) (emit `(emit-byte ~b)))
(defcompilefun vp-short (&rest b) (emit `(emit-short ~b)))
(defcompilefun vp-int (&rest b) (emit `(emit-int ~b)))
(defcompilefun vp-long (&rest b) (emit `(emit-long ~b)))

(defcompilefun vp-beq (l) (emit `(emit-beq ,l)))
(defcompilefun vp-bne (l) (emit `(emit-bne ,l)))
(defcompilefun vp-blt (l) (emit `(emit-blt ,l)))
(defcompilefun vp-ble (l) (emit `(emit-ble ,l)))
(defcompilefun vp-bgt (l) (emit `(emit-bgt ,l)))
(defcompilefun vp-bge (l) (emit `(emit-bge ,l)))

(defcompilefun vp-push (&rest b) (emit `(emit-push ~b)))
(defcompilefun vp-pop (&rest b) (emit `(emit-pop ~b)))

(defcompilefun vp-call (&rest b) (emit `(emit-call ~b)))
(defcompilefun vp-call-r (&rest b) (emit `(emit-call-r ~b)))
(defcompilefun vp-call-i (&rest b) (emit `(emit-call-i ~b)))
(defcompilefun vp-call-d (&rest b) (emit `(emit-call-d ~b)))
(defcompilefun vp-call-p (&rest b) (emit `(emit-call-p ~b)))

(defcompilefun vp-jmp (&rest b) (emit `(emit-jmp ~b)))
(defcompilefun vp-jmp-r (&rest b) (emit `(emit-jmp-r ~b)))
(defcompilefun vp-jmp-i (&rest b) (emit `(emit-jmp-i ~b)))
(defcompilefun vp-jmp-d (&rest b) (emit `(emit-jmp-d ~b)))
(defcompilefun vp-jmp-p (&rest b) (emit `(emit-jmp-p ~b)))

(defcompilefun vp-lea-i (&rest b) (emit `(emit-lea-i ~b)))
(defcompilefun vp-lea-d (&rest b) (emit `(emit-lea-d ~b)))
(defcompilefun vp-lea-p (&rest b) (emit `(emit-lea-p ~b)))

(defcompilefun vp-cpy-cr (&rest b) (emit `(emit-cpy-cr ~b)))
(defcompilefun vp-cpy-rr (&rest b) (emit `(emit-cpy-rr ~b)))
(defcompilefun vp-cpy-ir (&rest b) (emit `(emit-cpy-ir ~b)))
(defcompilefun vp-cpy-dr (&rest b) (emit `(emit-cpy-dr ~b)))
(defcompilefun vp-cpy-pr (&rest b) (emit `(emit-cpy-pr ~b)))
(defcompilefun vp-cpy-ri (&rest b) (emit `(emit-cpy-ri ~b)))
(defcompilefun vp-cpy-rd (&rest b) (emit `(emit-cpy-rd ~b)))
(defcompilefun vp-cpy-rp (&rest b) (emit `(emit-cpy-rp ~b)))

(defcompilefun vp-cpy-ir-b (&rest b) (emit `(emit-cpy-ir-b ~b)))
(defcompilefun vp-cpy-dr-b (&rest b) (emit `(emit-cpy-dr-b ~b)))
(defcompilefun vp-cpy-pr-b (&rest b) (emit `(emit-cpy-pr-b ~b)))
(defcompilefun vp-cpy-ir-ub (&rest b) (emit `(emit-cpy-ir-ub ~b)))
(defcompilefun vp-cpy-dr-ub (&rest b) (emit `(emit-cpy-dr-ub ~b)))
(defcompilefun vp-cpy-pr-ub (&rest b) (emit `(emit-cpy-pr-ub ~b)))

(defcompilefun vp-cpy-ir-s (&rest b) (emit `(emit-cpy-ir-s ~b)))
(defcompilefun vp-cpy-dr-s (&rest b) (emit `(emit-cpy-dr-s ~b)))
(defcompilefun vp-cpy-pr-s (&rest b) (emit `(emit-cpy-pr-s ~b)))
(defcompilefun vp-cpy-ir-us (&rest b) (emit `(emit-cpy-ir-us ~b)))
(defcompilefun vp-cpy-dr-us (&rest b) (emit `(emit-cpy-dr-us ~b)))
(defcompilefun vp-cpy-pr-us (&rest b) (emit `(emit-cpy-pr-us ~b)))

(defcompilefun vp-cpy-ir-i (&rest b) (emit `(emit-cpy-ir-i ~b)))
(defcompilefun vp-cpy-dr-i (&rest b) (emit `(emit-cpy-dr-i ~b)))
(defcompilefun vp-cpy-pr-i (&rest b) (emit `(emit-cpy-pr-i ~b)))
(defcompilefun vp-cpy-ir-ui (&rest b) (emit `(emit-cpy-ir-ui ~b)))
(defcompilefun vp-cpy-dr-ui (&rest b) (emit `(emit-cpy-dr-ui ~b)))
(defcompilefun vp-cpy-pr-ui (&rest b) (emit `(emit-cpy-pr-ui ~b)))

(defcompilefun vp-cpy-ri-b (&rest b) (emit `(emit-cpy-ri-b ~b)))
(defcompilefun vp-cpy-rd-b (&rest b) (emit `(emit-cpy-rd-b ~b)))
(defcompilefun vp-cpy-rp-b (&rest b) (emit `(emit-cpy-rp-b ~b)))

(defcompilefun vp-cpy-ri-s (&rest b) (emit `(emit-cpy-ri-s ~b)))
(defcompilefun vp-cpy-rd-s (&rest b) (emit `(emit-cpy-rd-s ~b)))
(defcompilefun vp-cpy-rp-s (&rest b) (emit `(emit-cpy-rp-s ~b)))

(defcompilefun vp-cpy-ri-i (&rest b) (emit `(emit-cpy-ri-i ~b)))
(defcompilefun vp-cpy-rd-i (&rest b) (emit `(emit-cpy-rd-i ~b)))
(defcompilefun vp-cpy-rp-i (&rest b) (emit `(emit-cpy-rp-i ~b)))

(defcompilefun vp-add-cr (&rest b) (emit `(emit-add-cr ~b)))
(defcompilefun vp-add-rr (&rest b) (emit `(emit-add-rr ~b)))
(defcompilefun vp-add-ir (&rest b) (emit `(emit-add-ir ~b)))
(defcompilefun vp-add-dr (&rest b) (emit `(emit-add-dr ~b)))
(defcompilefun vp-add-pr (&rest b) (emit `(emit-add-pr ~b)))

(defcompilefun vp-sub-cr (&rest b) (emit `(emit-sub-cr ~b)))
(defcompilefun vp-sub-rr (&rest b) (emit `(emit-sub-rr ~b)))
(defcompilefun vp-sub-ir (&rest b) (emit `(emit-sub-ir ~b)))
(defcompilefun vp-sub-dr (&rest b) (emit `(emit-sub-dr ~b)))
(defcompilefun vp-sub-pr (&rest b) (emit `(emit-sub-pr ~b)))

(defcompilefun vp-cmp-cr (&rest b) (emit `(emit-cmp-cr ~b)))
(defcompilefun vp-cmp-rr (&rest b) (emit `(emit-cmp-rr ~b)))
(defcompilefun vp-cmp-ir (&rest b) (emit `(emit-cmp-ir ~b)))
(defcompilefun vp-cmp-dr (&rest b) (emit `(emit-cmp-dr ~b)))
(defcompilefun vp-cmp-pr (&rest b) (emit `(emit-cmp-pr ~b)))

(defcompilefun vp-mul-cr (&rest b) (emit `(emit-mul-cr ~b)))
(defcompilefun vp-mul-rr (&rest b) (emit `(emit-mul-rr ~b)))
(defcompilefun vp-mul-ir (&rest b) (emit `(emit-mul-ir ~b)))
(defcompilefun vp-mul-dr (&rest b) (emit `(emit-mul-dr ~b)))
(defcompilefun vp-mul-pr (&rest b) (emit `(emit-mul-pr ~b)))

(defcompilefun vp-and-cr (&rest b) (emit `(emit-and-cr ~b)))
(defcompilefun vp-and-rr (&rest b) (emit `(emit-and-rr ~b)))
(defcompilefun vp-and-ir (&rest b) (emit `(emit-and-ir ~b)))
(defcompilefun vp-and-dr (&rest b) (emit `(emit-and-dr ~b)))
(defcompilefun vp-and-pr (&rest b) (emit `(emit-and-pr ~b)))

(defcompilefun vp-or-cr (&rest b) (emit `(emit-or-cr ~b)))
(defcompilefun vp-or-rr (&rest b) (emit `(emit-or-rr ~b)))
(defcompilefun vp-or-ir (&rest b) (emit `(emit-or-ir ~b)))
(defcompilefun vp-or-dr (&rest b) (emit `(emit-or-dr ~b)))
(defcompilefun vp-or-pr (&rest b) (emit `(emit-or-pr ~b)))

(defcompilefun vp-xor-cr (&rest b) (emit `(emit-xor-cr ~b)))
(defcompilefun vp-xor-rr (&rest b) (emit `(emit-xor-rr ~b)))
(defcompilefun vp-xor-ir (&rest b) (emit `(emit-xor-ir ~b)))
(defcompilefun vp-xor-dr (&rest b) (emit `(emit-xor-dr ~b)))
(defcompilefun vp-xor-pr (&rest b) (emit `(emit-xor-pr ~b)))

(defcompilefun vp-shl-cr (&rest b) (emit `(emit-shl-cr ~b)))
(defcompilefun vp-shl-rr (&rest b) (emit `(emit-shl-rr ~b)))
(defcompilefun vp-shr-cr (&rest b) (emit `(emit-shr-cr ~b)))
(defcompilefun vp-shr-rr (&rest b) (emit `(emit-shr-rr ~b)))
(defcompilefun vp-asr-cr (&rest b) (emit `(emit-asr-cr ~b)))
(defcompilefun vp-asr-rr (&rest b) (emit `(emit-asr-rr ~b)))

(defcompilefun vp-ret () (emit '(emit-ret)))
(defcompilefun vp-inc (r) (emit `(emit-inc ,r)))
(defcompilefun vp-dec (r) (emit `(emit-dec ,r)))
(defcompilefun vp-xchg-rr (&rest b) (emit `(emit-xchg-rr ~b)))

;;;;;;;;;;;;;
; Emit Buffer
;;;;;;;;;;;;;

(defcompilefun emit (f)
	(push *emit-buffer* f))

(defcompilefun emit-passes ()
	(defq *out-buffer-cnt* 0 *out-buffer-size* 0)
	(while (ne 2 *out-buffer-cnt*)
		(setq *out-buffer* (list))
		(each eval *emit-buffer*)
		(setq *out-buffer-cnt* (if (eq *out-buffer-size* (length *out-buffer*))
			(inc *out-buffer-cnt*)
			(progn (setq *out-buffer-size* (length *out-buffer*)) 0)))))

(defcompilefun print-emit-buffer ()
	(defq i 0)
	(while (lt i (length *emit-buffer*))
		(print i " -> " (elem i *emit-buffer*))
		(setq i (inc i))))

(defcompilefun print-out-buffer (c)
	(defq i 0)
	(while (lt i (length *out-buffer*))
		(if (eq (mod i c) 0)
			(progn
				(prin-base i 16 4) (prin " : ")))
		(prin-base (elem i *out-buffer*) 16 2) (prin " ")
		(setq i (inc i))
		(if (eq (mod i c) 0)
			(print)))
	(print))

(defcompilefun emit-label (s)
	(set s (length *out-buffer*)))

(defcompilefun emit-byte (&rest b)
	(each (lambda (x)
		(push *out-buffer* (bit-and x 0xff))) b))

(defcompilefun emit-short (&rest b)
	(each (lambda (x)
		(emit-byte x (bit-shr x 8))) b))

(defcompilefun emit-int (&rest b)
	(each (lambda (x)
		(emit-short x (bit-shr x 16))) b))

(defcompilefun emit-long (&rest b)
	(each (lambda (x)
		(emit-int x (bit-shr x 32))) b))

(defcompilefun emit-string (s)
	(each (lambda (x)
		(emit-byte (code x))) s))

(defcompilefun emit-align (a &optional b)
	(defq n (align (length *out-buffer*) a) b (if b b 0))
	(while (ne (length *out-buffer*) n)
		(emit-byte b)))

;;;;;;;;;;;;;;;;;;;;
; x64 Emit Functions
;;;;;;;;;;;;;;;;;;;;

(defcompilefun emit-rr (o s d)
	(defq s (reg s) sl (bit-and 7 s) sh (bit-shr s 3)
		d (reg d) dl (bit-and 7 d) dh (bit-shr d 3))
	(emit-byte (add 0x48 (bit-shl sh 2) dh) o (add 0xc0 (bit-shl sl 3) dl)))

(defcompilefun emit-dr (o s1 s2 d)
	(defq s1 (reg s1) s1l (bit-and 7 s1) s1h (bit-shr s1 3)
		s2 (reg s2) s2l (bit-and 7 s2) s2h (bit-shr s2 3)
		d (reg d) dl (bit-and 7 d) dh (bit-shr d 3))
	(emit-byte (add 0x48 (bit-shl dh 2) (bit-shl s2h 1) s1h)
		o (add 0x44 (bit-shl dl 3)) (add (bit-shl s2l 3) s1l) 0))

(defcompilefun emit-dr-bs (o s1 s2 d)
	(defq s1 (reg s1) s1l (bit-and 7 s1) s1h (bit-shr s1 3)
		s2 (reg s2) s2l (bit-and 7 s2) s2h (bit-shr s2 3)
		d (reg d) dl (bit-and 7 d) dh (bit-shr d 3))
	(emit-byte (add 0x48 (bit-shl dh 2) (bit-shl s2h 1) s1h)
		0x0f o (add 0x44 (bit-shl dl 3)) (add (bit-shl s2l 3) s1l) 0))

(defcompilefun emit-ir (o s c d)
	(defq s (reg s) sl (bit-and 7 s) sh (bit-shr s 3)
		d (reg d) dl (bit-and 7 d) dh (bit-shr d 3))
	(emit-byte (add 0x48 (bit-shl dh 2) sh) o)
	(cond
		((and (eq c 0) (ne s 5) (ne s 13))
			(emit-byte (add (bit-shl dl 3) sl))
			(if (or (eq s 4) (eq s 12)) (emit-byte 0x24)))
		((le -0x80 c 0x7f)
			(emit-byte (add 0x40 (bit-shl dl 3) sl))
			(if (or (eq s 4) (eq s 12)) (emit-byte 0x24))
			(emit-byte c))
		((le -0x80000000 c 0x7fffffff)
			(emit-byte (add 0x80 (bit-shl dl 3) sl))
			(if (or (eq s 4) (eq s 12)) (emit-byte 0x24))
			(emit-int c))
		(t (print "emit-ir constant out of range: " c))))

(defcompilefun emit-ir-bs (o s c d)
	(defq s (reg s) sl (bit-and 7 s) sh (bit-shr s 3)
		d (reg d) dl (bit-and 7 d) dh (bit-shr d 3))
	(emit-byte (add 0x48 (bit-shl dh 2) sh) 0x0f o)
	(cond
		((and (eq c 0) (ne s 5) (ne s 13))
			(emit-byte (add (bit-shl dl 3) sl))
			(if (or (eq s 4) (eq s 12)) (emit-byte 0x24)))
		((le -0x80 c 0x7f)
			(emit-byte (add 0x40 (bit-shl dl 3) sl))
			(if (or (eq s 4) (eq s 12)) (emit-byte 0x24))
			(emit-byte c))
		((le -0x80000000 c 0x7fffffff)
			(emit-byte (add 0x80 (bit-shl dl 3) sl))
			(if (or (eq s 4) (eq s 12)) (emit-byte 0x24))
			(emit-int c))
		(t (print "emit-ir-bs constant out of range: " c))))

(defcompilefun emit-pr (o c d)
	(defq d (reg d) dl (bit-and 7 d) dh (bit-shr d 3) c (sub c 7))
	(cond
		((le -0x80000000 c 0x7fffffff)
			(emit-byte (add 0x48 (bit-shl dh 2)) o (add 0x5 (bit-shl dl 3)))
			(emit-int c))
		(t (print "emit-pr constant out of range: " c))))

(defcompilefun emit-pr-bs (o c d)
	(defq d (reg d) dl (bit-and 7 d) dh (bit-shr d 3) c (sub c 8))
	(cond
		((le -0x80000000 c 0x7fffffff)
			(emit-byte (add 0x48 (bit-shl dh 2)) 0x0f o (add 0x5 (bit-shl dl 3)))
			(emit-int c))
		(t (print "emit-pr-bs constant out of range: " c))))

(defcompilefun emit-shift-cr (o c d)
	(defq d (reg d) dl (bit-and 7 d) dh (bit-shr d 3))
	(emit-byte (add 0x48 dh))
	(cond
		((eq c 1)
			(emit-byte 0xd1 (add o dl)))
		((le c 0xff)
			(emit-byte 0xc1 (add o dl) c))
		(t (print "emit-shift-cr constant out of range: " c))))

(defcompilefun emit-shift-rr (o s d)
	(defq dn (reg d) dl (bit-and 7 dn) dh (bit-shr dn 3))
	(cond
		((eql s r1)
			(emit-byte (add 0x48 dh) 0xd3 (add o dl)))
		(t
			(emit-push d s r0 r1)
			(emit-cpy-ir r4 24 r0)
			(emit-cpy-ir r4 16 r1)
			(emit-byte 0x48 0xd3 o)
			(emit-cpy-ri r0 r4 24)
			(emit-pop d s r0 r1))))

(defcompilefun emit-push (&rest b)
	(each (lambda (r)
		(setq r (reg r))
		(if (ge r 8)
			(emit-byte 0x41 (add 0x48 r))
			(emit-byte (add 0x50 r)))) b))

(defcompilefun emit-pop (&rest b)
	(each-rev (lambda (r)
		(setq r (reg r))
		(if (ge r 8)
			(emit-byte 0x41 (add 0x50 r))
			(emit-byte (add 0x58 r)))) b))

(defcompilefun emit-beq (%1) ())
(defcompilefun emit-bne (%1) ())
(defcompilefun emit-blt (%1) ())
(defcompilefun emit-ble (%1) ())
(defcompilefun emit-bgt (%1) ())
(defcompilefun emit-bge (%1) ())

(defcompilefun emit-call (&rest b) ())
(defcompilefun emit-call-r (&rest b) ())
(defcompilefun emit-call-i (&rest b) ())
(defcompilefun emit-call-d (&rest b) ())
(defcompilefun emit-call-p (&rest b) ())

(defcompilefun emit-jmp (&rest b) ())
(defcompilefun emit-jmp-r (&rest b) ())
(defcompilefun emit-jmp-i (&rest b) ())
(defcompilefun emit-jmp-d (&rest b) ())
(defcompilefun emit-jmp-p (&rest b) ())

(defcompilefun emit-lea-i (s c d) (emit-ir 0x8d s c d))
(defcompilefun emit-lea-d (s1 s2 d) (emit-dr 0x8d s1 s2 d))
(defcompilefun emit-lea-p (l d) (emit-pr 0x8d (sub l (length *out-buffer*)) d))

(defcompilefun emit-cpy-cr (c r)
	(defq r (reg r) rl (bit-and r 7) rh (bit-shr r 3))
	(cond
		((le -0x80000000 c 0x7fffffff)
			(if (ge r 8) (emit-byte 0x41))
			(emit-byte (add 0xb8 rl))
			(emit-int c))
		(t
			(emit-byte (add 0x48 rh) (add 0xb8 rl))
			(emit-long c))))

(defcompilefun emit-cpy-rr (s d) (emit-rr 0x89 s d))
(defcompilefun emit-cpy-ir (s c d) (emit-ir 0x8b s c d))
(defcompilefun emit-cpy-dr (s1 s2 d) (emit-dr 0x8b s1 s2 d))
(defcompilefun emit-cpy-pr (l d) (emit-pr 0x8b (sub l (length *out-buffer*)) d))

(defcompilefun emit-cpy-ri (s d c)
	(defq s (reg s) sl (bit-and 7 s) sh (bit-shr s 3)
		d (reg d) dl (bit-and 7 d) dh (bit-shr d 3))
	(cond
		((eq c 0)
			(emit-byte (add 0x48 (bit-shl sh 2) dh) 0x89 (add (bit-shl sl 3) dl))
			(if (or (eq d 4) (eq d 12)) (emit-byte 0x24))
			(emit-byte c))
		((le -0x80 c 0x7f)
			(emit-byte (add 0x48 (bit-shl sh 2) dh) 0x89 (add 0x40 (bit-shl sl 3) dl))
			(if (or (eq d 4) (eq d 12)) (emit-byte 0x24))
			(emit-byte c))
		((le -0x80000000 c 0x7fffffff)
			(emit-byte (add 0x48 (bit-shl sh 2) dh) 0x89 (add 0x80 (bit-shl sl 3) dl))
			(if (or (eq d 4) (eq d 12)) (emit-byte 0x24))
			(emit-int c))
		(t (print "emit-cpy-ri constant out of range: " c))))

(defcompilefun emit-cpy-rd (s1 s2 d)
	(defq s1 (reg s1) s1l (bit-and 7 s1) s1h (bit-shr s1 3)
		s2 (reg s2) s2l (bit-and 7 s2) s2h (bit-shr s2 3)
		d (reg d) dl (bit-and 7 d) dh (bit-shr d 3))
	(emit-byte (add 0x48 (bit-shl dh 2) (bit-shl s2h 1) s1h)
		0x89 (add 0x44 (bit-shl dl 3)) (add (bit-shl s2l 3) s1l) 0))

(defcompilefun emit-cpy-rp (d c)
	(defq d (reg d) dl (bit-and 7 d) dh (bit-shr d 3) c (sub c (length *out-buffer*) 7))
	(cond
		((le -0x80000000 c 0x7fffffff)
			(emit-byte (add 0x48 (bit-shl dh 2)) 0x89 (add 0x5 (bit-shl dl 3)))
			(emit-int c))
		(t (print "emit-cpy-rp constant out of range: " c))))

(defcompilefun emit-cpy-ir-b (s c d) (emit-ir-bs 0xbe s c d))
(defcompilefun emit-cpy-dr-b (s1 s2 d) (emit-dr-bs 0xbe s1 s2 d))
(defcompilefun emit-cpy-pr-b (l d) (emit-pr-bs 0xbe (sub l (length *out-buffer*)) d))

(defcompilefun emit-cpy-ir-ub (s c d) (emit-ir-bs 0xb6 s c d))
(defcompilefun emit-cpy-dr-ub (s1 s2 d) (emit-dr-bs 0xb6 s1 s2 d))
(defcompilefun emit-cpy-pr-ub (l d) (emit-pr-bs 0xb6 (sub l (length *out-buffer*)) d))

(defcompilefun emit-cpy-ir-s (s c d) (emit-ir-bs 0xbf s c d))
(defcompilefun emit-cpy-dr-s (s1 s2 d) (emit-dr-bs 0xbf s1 s2 d))
(defcompilefun emit-cpy-pr-s (l d) (emit-pr-bs 0xbf (sub l (length *out-buffer*)) d))

(defcompilefun emit-cpy-ir-us (s c d) (emit-ir-bs 0xb7 s c d))
(defcompilefun emit-cpy-dr-us (s1 s2 d) (emit-dr-bs 0xb7 s1 s2 d))
(defcompilefun emit-cpy-pr-us (l d) (emit-pr-bs 0xb7 (sub l (length *out-buffer*)) d))

(defcompilefun emit-cpy-ir-i (s c d)
	(defq s (reg s) sl (bit-and 7 s) sh (bit-shr s 3)
		d (reg d) dl (bit-and 7 d) dh (bit-shr d 3))
	(emit-byte (add 0x48 (bit-shl dh 2) sh) 0x63)
	(cond
		((and (eq c 0) (ne s 5) (ne s 13))
			(emit-byte (add (bit-shl dl 3) sl))
			(if (or (eq s 4) (eq s 12)) (emit-byte 0x24)))
		((le -0x80 c 0x7f)
			(emit-byte (add 0x40 (bit-shl dl 3) sl))
			(if (or (eq s 4) (eq s 12)) (emit-byte 0x24))
			(emit-byte c))
		((le -0x80000000 c 0x7fffffff)
			(emit-byte (add 0x80 (bit-shl dl 3) sl))
			(if (or (eq s 4) (eq s 12)) (emit-byte 0x24))
			(emit-int c))
		(t (print "emit-cpy-ir-i constant out of range: " c))))

(defcompilefun emit-cpy-dr-i (s1 s2 d)
	(defq s1 (reg s1) s1l (bit-and 7 s1) s1h (bit-shr s1 3)
		s2 (reg s2) s2l (bit-and 7 s2) s2h (bit-shr s2 3)
		d (reg d) dl (bit-and 7 d) dh (bit-shr d 3))
	(emit-byte (add 0x48 (bit-shl dh 2) (bit-shl s2h 1) s1h)
		0x63 (add 0x44 (bit-shl dl 3)) (add (bit-shl s2l 3) s1l) 0))

(defcompilefun emit-cpy-pr-i (c d)
	(defq d (reg d) dl (bit-and 7 d) dh (bit-shr d 3) c (sub c (length *out-buffer*) 7))
	(cond
		((le -0x80000000 c 0x7fffffff)
			(emit-byte (add 0x48 (bit-shl dh 2)) 0x63 (add 0x5 (bit-shl dl 3)))
			(emit-int c))
		(t (print "emit-cpy-pr-i constant out of range: " c))))

(defcompilefun emit-cpy-ir-ui (s c d)
	(defq s (reg s) sl (bit-and 7 s) sh (bit-shr s 3)
		d (reg d) dl (bit-and 7 d) dh (bit-shr d 3))
	(if (or (ge s 8) (ge d 8)) (emit-byte (add 0x40 (bit-shl dh 2) sh)))
	(emit-byte 0x8b)
	(cond
		((and (eq c 0) (ne s 5) (ne s 13))
			(emit-byte (add (bit-shl dl 3) sl))
			(if (or (eq s 4) (eq s 12)) (emit-byte 0x24)))
		((le -0x80 c 0x7f)
			(emit-byte (add 0x40 (bit-shl dl 3) sl))
			(if (or (eq s 4) (eq s 12)) (emit-byte 0x24))
			(emit-byte c))
		((le -0x80000000 c 0x7fffffff)
			(emit-byte (add 0x80 (bit-shl dl 3) sl))
			(if (or (eq s 4) (eq s 12)) (emit-byte 0x24))
			(emit-int c))
		(t (print "emit-cpy-ir-ui constant out of range: " c))))

(defcompilefun emit-cpy-dr-ui (s1 s2 d)
	(defq s1 (reg s1) s1l (bit-and 7 s1) s1h (bit-shr s1 3)
		s2 (reg s2) s2l (bit-and 7 s2) s2h (bit-shr s2 3)
		d (reg d) dl (bit-and 7 d) dh (bit-shr d 3))
	(emit-byte (add 0x40 (bit-shl dh 2) (bit-shl s2h 1) s1h)
		0x8b (add 0x44 (bit-shl dl 3)) (add (bit-shl s2l 3) s1l) 0))

(defcompilefun emit-cpy-pr-ui (c d)
	(defq d (reg d) dl (bit-and 7 d) dh (bit-shr d 3) c (sub c (length *out-buffer*) 7))
	(cond
		((le -0x80000000 c 0x7fffffff)
			(emit-byte (add 0x40 (bit-shl dh 2)) 0x8b (add 0x5 (bit-shl dl 3)))
			(emit-int c))
		(t (print "emit-pr-ui constant out of range: " c))))

(defcompilefun emit-cpy-ri-b (s d c)
	(defq s (reg s) sl (bit-and 7 s) sh (bit-shr s 3)
		d (reg d) dl (bit-and 7 d) dh (bit-shr d 3))
	(if (or (ge s 4) (ge d 8)) (emit-byte (add 0x40 (bit-shl sh 2) dh)))
	(emit-byte 0x88)
	(cond
		((and (eq c 0) (ne d 5) (ne d 13))
			(emit-byte (add (bit-shl sl 3) dl))
			(if (or (eq d 4) (eq d 12)) (emit-byte 0x24)))
		((le -0x80 c 0x7f)
			(emit-byte (add 0x40 (bit-shl sl 3) dl))
			(if (or (eq d 4) (eq d 12)) (emit-byte 0x24))
			(emit-byte c))
		((le -0x80000000 c 0x7fffffff)
			(emit-byte (add 0x80 (bit-shl sl 3) dl))
			(if (or (eq d 4) (eq d 12)) (emit-byte 0x24))
			(emit-int c))
		(t (print "emit-cpy-ri-b constant out of range: " c))))

(defcompilefun emit-cpy-rd-b (s1 s2 d)
	(defq s1 (reg s1) s1l (bit-and 7 s1) s1h (bit-shr s1 3)
		s2 (reg s2) s2l (bit-and 7 s2) s2h (bit-shr s2 3)
		d (reg d) dl (bit-and 7 d) dh (bit-shr d 3))
	(emit-byte (add 0x40 (bit-shl dh 2) (bit-shl s2h 1) s1h)
		0x88 (add 0x44 (bit-shl dl 3)) (add (bit-shl s2l 3) s1l) 0))

(defcompilefun emit-cpy-rp-b (d c)
	(defq d (reg d) dl (bit-and 7 d) dh (bit-shr d 3) c (sub c (length *out-buffer*) 7))
	(cond
		((le -0x80000000 c 0x7fffffff)
			(emit-byte (add 0x40 (bit-shl dh 2)) 0x88 (add 0x5 (bit-shl dl 3)))
			(emit-int c))
		(t (print "emit-cpy-rp-b constant out of range: " c))))

(defcompilefun emit-cpy-ri-s (s d c)
	(defq s (reg s) sl (bit-and 7 s) sh (bit-shr s 3)
		d (reg d) dl (bit-and 7 d) dh (bit-shr d 3))
	(emit-byte 0x66)
	(if (or (ge s 8) (ge d 8)) (emit-byte (add 0x40 (bit-shl sh 2) dh)))
	(emit-byte 0x89)
	(cond
		((and (eq c 0) (ne d 5) (ne d 13))
			(emit-byte (add (bit-shl sl 3) dl))
			(if (or (eq d 4) (eq d 12)) (emit-byte 0x24)))
		((le -0x80 c 0x7f)
			(emit-byte (add 0x40 (bit-shl sl 3) dl))
			(if (or (eq d 4) (eq d 12)) (emit-byte 0x24))
			(emit-byte c))
		((le -0x80000000 c 0x7fffffff)
			(emit-byte (add 0x80 (bit-shl sl 3) dl))
			(if (or (eq d 4) (eq d 12)) (emit-byte 0x24))
			(emit-int c))
		(t (print "emit-cpy-ri-s constant out of range: " c))))

(defcompilefun emit-cpy-rd-s (s1 s2 d)
	(defq s1 (reg s1) s1l (bit-and 7 s1) s1h (bit-shr s1 3)
		s2 (reg s2) s2l (bit-and 7 s2) s2h (bit-shr s2 3)
		d (reg d) dl (bit-and 7 d) dh (bit-shr d 3))
	(emit-byte 0x66 (add 0x40 (bit-shl dh 2) (bit-shl s2h 1) s1h)
		0x89 (add 0x44 (bit-shl dl 3)) (add (bit-shl s2l 3) s1l) 0))

(defcompilefun emit-cpy-rp-s (d c)
	(defq d (reg d) dl (bit-and 7 d) dh (bit-shr d 3) c (sub c (length *out-buffer*) 8))
	(cond
		((le -0x80000000 c 0x7fffffff)
			(emit-byte 0x66 (add 0x40 (bit-shl dh 2)) 0x89 (add 0x5 (bit-shl dl 3)))
			(emit-int c))
		(t (print "emit-cpy-rp-s constant out of range: " c))))

(defcompilefun emit-cpy-ri-i (s d c)
	(defq s (reg s) sl (bit-and 7 s) sh (bit-shr s 3)
		d (reg d) dl (bit-and 7 d) dh (bit-shr d 3))
	(if (or (ge s 8) (ge d 8)) (emit-byte (add 0x40 (bit-shl sh 2) dh)))
	(emit-byte 0x89)
	(cond
		((and (eq c 0) (ne d 5) (ne d 13))
			(emit-byte (add (bit-shl sl 3) dl))
			(if (or (eq d 4) (eq d 12)) (emit-byte 0x24)))
		((le -0x80 c 0x7f)
			(emit-byte (add 0x40 (bit-shl sl 3) dl))
			(if (or (eq d 4) (eq d 12)) (emit-byte 0x24))
			(emit-byte c))
		((le -0x80000000 c 0x7fffffff)
			(emit-byte (add 0x80 (bit-shl sl 3) dl))
			(if (or (eq d 4) (eq d 12)) (emit-byte 0x24))
			(emit-int c))
		(t (print "emit-cpy-ri-i constant out of range: " c))))

(defcompilefun emit-cpy-rd-i (s1 s2 d)
	(defq s1 (reg s1) s1l (bit-and 7 s1) s1h (bit-shr s1 3)
		s2 (reg s2) s2l (bit-and 7 s2) s2h (bit-shr s2 3)
		d (reg d) dl (bit-and 7 d) dh (bit-shr d 3))
	(emit-byte (add 0x40 (bit-shl dh 2) (bit-shl s2h 1) s1h)
		0x89 (add 0x44 (bit-shl dl 3)) (add (bit-shl s2l 3) s1l) 0))

(defcompilefun emit-cpy-rp-i (d c)
	(defq d (reg d) dl (bit-and 7 d) dh (bit-shr d 3) c (sub c (length *out-buffer*) 7))
	(cond
		((le -0x80000000 c 0x7fffffff)
			(emit-byte (add 0x40 (bit-shl dh 2)) 0x89 (add 0x5 (bit-shl dl 3)))
			(emit-int c))
		(t (print "emit-rp-i constant out of range: " c))))

(defcompilefun emit-add-cr (c r)
	(defq r (reg r) rl (bit-and 7 r) rh (bit-shr r 3))
	(emit-byte (add 0x48 rh))
	(cond
		((le -0x80 c 0x7f)
			(emit-byte 0x83 (add 0xc0 rl) c))
		((le -0x80000000 c 0x7fffffff)
			(if (eq r 0)
				(emit-byte 0x05)
				(emit-byte 0x81 (add 0xc0 rl)))
			(emit-int c))
		(t (print "emit-add-cr constant out of range: " c))))

(defcompilefun emit-add-rr (s d) (emit-rr 0x01 s d))
(defcompilefun emit-add-ir (s c d) (emit-ir 0x03 s c d))
(defcompilefun emit-add-dr (s1 s2 d) (emit-dr 0x03 s1 s2 d))
(defcompilefun emit-add-pr (l d) (emit-pr 0x03 (sub l (length *out-buffer*)) d))

(defcompilefun emit-sub-cr (c r)
	(defq r (reg r) rl (bit-and 7 r) rh (bit-shr r 3))
	(emit-byte (add 0x48 rh))
	(cond
		((le -0x80 c 0x7f)
			(emit-byte 0x83 (add 0xe8 rl) c))
		((le -0x80000000 c 0x7fffffff)
			(if (eq r 0)
				(emit-byte 0x2d)
				(emit-byte 0x81 (add 0xe8 rl)))
			(emit-int c))
		(t (print "emit-sub-cr constant out of range: " c))))

(defcompilefun emit-sub-rr (s d) (emit-rr 0x29 s d))
(defcompilefun emit-sub-ir (s c d) (emit-ir 0x2b s c d))
(defcompilefun emit-sub-dr (s1 s2 d) (emit-dr 0x2b s1 s2 d))
(defcompilefun emit-sub-pr (l d) (emit-pr 0x2b (sub l (length *out-buffer*)) d))

(defcompilefun emit-cmp-cr (c r)
	(defq r (reg r) rl (bit-and 7 r) rh (bit-shr r 3))
	(emit-byte (add 0x48 rh))
	(cond
		((le -0x80 c 0x7f)
			(emit-byte 0x83 (add 0xf8 rl) c))
		((le -0x80000000 c 0x7fffffff)
			(if (eq r 0)
				(emit-byte 0x3d)
				(emit-byte 0x81 (add 0xf8 rl)))
			(emit-int c))
		(t (print "emit-cmp-cr constant out of range: " c))))

(defcompilefun emit-cmp-rr (s d) (emit-rr 0x39 s d))
(defcompilefun emit-cmp-ir (s c d) (emit-ir 0x3b s c d))
(defcompilefun emit-cmp-dr (s1 s2 d) (emit-dr 0x3b s1 s2 d))
(defcompilefun emit-cmp-pr (l d) (emit-pr 0x3b (sub l (length *out-buffer*)) d))

(defcompilefun emit-and-cr (c r)
	(defq r (reg r) rl (bit-and 7 r) rh (bit-shr r 3))
	(emit-byte (add 0x48 rh))
	(cond
		((le -0x80 c 0x7f)
			(emit-byte 0x83 (add 0xe0 rl) c))
		((le -0x80000000 c 0x7fffffff)
			(if (eq r 0)
				(emit-byte 0x25)
				(emit-byte 0x81 (add 0xe0 rl)))
			(emit-int c))
		(t (print "emit-and-cr constant out of range: " c))))

(defcompilefun emit-and-rr (s d) (emit-rr 0x21 s d))
(defcompilefun emit-and-ir (s c d) (emit-ir 0x23 s c d))
(defcompilefun emit-and-dr (s1 s2 d) (emit-dr 0x23 s1 s2 d))
(defcompilefun emit-and-pr (l d) (emit-pr 0x23 (sub l (length *out-buffer*)) d))

(defcompilefun emit-or-cr (c r)
	(defq r (reg r) rl (bit-and 7 r) rh (bit-shr r 3))
	(emit-byte (add 0x48 rh))
	(cond
		((le -0x80 c 0x7f)
			(emit-byte 0x83 (add 0xc8 rl) c))
		((le -0x80000000 c 0x7fffffff)
			(if (eq r 0)
				(emit-byte 0x0d)
				(emit-byte 0x81 (add 0xc8 rl)))
			(emit-int c))
		(t (print "emit-or-cr constant out of range: " c))))

(defcompilefun emit-or-rr (s d) (emit-rr 0x09 s d))
(defcompilefun emit-or-ir (s c d) (emit-ir 0x0b s c d))
(defcompilefun emit-or-dr (s1 s2 d) (emit-dr 0x0b s1 s2 d))
(defcompilefun emit-or-pr (l d) (emit-pr 0x0b (sub l (length *out-buffer*)) d))

(defcompilefun emit-xor-cr (c r)
	(defq r (reg r) rl (bit-and 7 r) rh (bit-shr r 3))
	(emit-byte (add 0x48 rh))
	(cond
		((le -0x80 c 0x7f)
			(emit-byte 0x83 (add 0xf0 rl) c))
		((le -0x80000000 c 0x7fffffff)
			(if (eq r 0)
				(emit-byte 0x35)
				(emit-byte 0x81 (add 0xf0 rl)))
			(emit-int c))
		(t (print "emit-xor-cr constant out of range: " c))))

(defcompilefun emit-xor-rr (s d) (emit-rr 0x31 s d))
(defcompilefun emit-xor-ir (s c d) (emit-ir 0x33 s c d))
(defcompilefun emit-xor-dr (s1 s2 d) (emit-dr 0x33 s1 s2 d))
(defcompilefun emit-xor-pr (l d) (emit-pr 0x33 (sub l (length *out-buffer*)) d))

(defcompilefun emit-shl-cr (c r) (emit-shift-cr 0xe0 c r))
(defcompilefun emit-shl-rr (s d) (emit-shift-rr 0xe0 s d))
(defcompilefun emit-shr-cr (c r) (emit-shift-cr 0xe8 c r))
(defcompilefun emit-shr-rr (s d) (emit-shift-rr 0xe8 s d))
(defcompilefun emit-asr-cr (c r) (emit-shift-cr 0xf8 c r))
(defcompilefun emit-asr-rr (s d) (emit-shift-rr 0xf8 s d))

(defcompilefun emit-mul-cr (c r)
	(defq r (reg r) rl (bit-and r 7) rh (bit-shr r 3))
	(emit-byte (add 0x48 (bit-shl rh 2) rh))
	(cond
		((le -0x80 c 0x7f)
			(emit-byte 0x6b (add 0xc0 rl (bit-shl rl 3)) c))
		((le -0x80000000 c 0x7fffffff)
			(emit-byte 0x69 (add 0xc0 rl (bit-shl rl 3)))
			(emit-int c))
		(t (print "emit-mul-cr constant out of range: " c))))

(defcompilefun emit-mul-rr (s d)
	(defq s (reg s) sl (bit-and 7 s) sh (bit-shr s 3)
		d (reg d) dl (bit-and 7 d) dh (bit-shr d 3))
	(emit-byte (add 0x48 (bit-shl dh 2) sh) 0x0f 0xaf (add 0xc0 (bit-shl dl 3) sl)))

(defcompilefun emit-mul-ir (s c d)
	(defq s (reg s) sl (bit-and 7 s) sh (bit-shr s 3)
		d (reg d) dl (bit-and 7 d) dh (bit-shr d 3))
	(emit-byte (add 0x48 (bit-shl dh 2) sh) 0x0f 0xaf)
	(cond
		((and (eq c 0) (ne s 5) (ne s 13))
			(emit-byte (add (bit-shl dl 3) sl))
			(if (or (eq s 4) (eq s 12)) (emit-byte 0x24)))
		((le -0x80 c 0x7f)
			(emit-byte (add 0x40 (bit-shl dl 3) sl))
			(if (or (eq s 4) (eq s 12)) (emit-byte 0x24))
			(emit-byte c))
		((le -0x80000000 c 0x7fffffff)
			(emit-byte (add 0x80 (bit-shl dl 3) sl))
			(if (or (eq s 4) (eq s 12)) (emit-byte 0x24))
			(emit-int c))
		(t (print "emit-mul-ir constant out of range: " c))))

(defcompilefun emit-mul-dr (s1 s2 d)
	(defq s1 (reg s1) s1l (bit-and 7 s1) s1h (bit-shr s1 3)
		s2 (reg s2) s2l (bit-and 7 s2) s2h (bit-shr s2 3)
		d (reg d) dl (bit-and 7 d) dh (bit-shr d 3))
	(emit-byte (add 0x48 (bit-shl dh 2) (bit-shl s2h 1) s1h)
		0x0f 0xaf (add 0x44 (bit-shl dl 3)) (add (bit-shl s2l 3) s1l) 0))

(defcompilefun emit-mul-pr (c d)
	(defq d (reg d) dl (bit-and 7 d) dh (bit-shr d 3) c (sub c (length *out-buffer*) 8))
	(cond
		((le -0x80000000 c 0x7fffffff)
			(emit-byte (add 0x48 (bit-shl dh 2)) 0x0f 0xaf (add 0x5 (bit-shl dl 3)))
			(emit-int c))
		(t (print "emit-mul-pr constant out of range: " c))))

(defcompilefun emit-ret () (emit-byte 0xc3))

(defcompilefun emit-inc (r)
	(defq r (reg r) rl (bit-and 7 r) rh (bit-shr r 3))
	(emit-byte (add 0x48 rh) 0xff (add 0xc0 rl)))

(defcompilefun emit-dec (r)
	(defq r (reg r) rl (bit-and 7 r) rh (bit-shr r 3))
	(emit-byte (add 0x48 rh) 0xff (add 0xc8 rl)))

(defcompilefun emit-xchg-rr (s d)
	(if (eql s r0) (setq s d d r0))
	(defq s (reg s) sl (bit-and 7 s) sh (bit-shr s 3)
		d (reg d) dl (bit-and 7 d) dh (bit-shr d 3))
	(if (eq d 0)
		(emit-byte (add 0x48 sh) (add 0x90 sl))
		(emit-byte (add 0x48 (bit-shl sh 2) dh) 0x87 (add 0xc0 (bit-shl sl 3) dl))))
